#!/bin/bash
{% set rtmp_port = docker.ports["nginx.ports.rtmp"] %}
set -o xtrace

# input and output
input=$(find {{"MOVIEDIR"|env}} -regex '{{media.video_re}}' -print -quit)
{% if ffmpeg.subtitles -%}
	subs=$(find {{"MOVIEDIR"|env}} -regex '{{media.subtitles_re}}' -print -quit)
{% else -%}
	subs=""
{% endif %}
{% if ":" in rtmp_port -%}
	rtmp_url="rtmp://{{ rtmp_port }}/{{nginx.rtmp.application}}"
{% else -%}
	rtmp_url="rtmp://127.0.0.1:{{rtmp_port}}/{{nginx.rtmp.application}}"
{% endif %}
rtmp_key="{{html.video_id}}"

# subtitles filter
if [ "$subs" != "" ]; then
	vf_subs=",subtitles='$subs':force_style='FontSize=24,FontName=Verdana'"
	#:'shift=-20\:10'"
else
	vf_subs=""
fi

# scale filters
scale720p="(iw*sar)*min(1280/(iw*sar)\,720/ih):ih*min(1280/(iw*sar)\,720/ih), pad=1280:720:(1280-iw*min(1280/iw\,720/ih))/2:(720-ih*min(1280/iw\,720/ih))/2"
scale1080p="(iw*sar)*min(1920/(iw*sar)\,1080/ih):ih*min(1920/(iw*sar)\,1080/ih), pad=1920:1080:(1920-iw*min(1920/iw\,1080/ih))/2:(1080-ih*min(1920/iw\,1080/ih))/2"

{# create video encoding options #}
{% set ffmpegvc %}
{% set v = ffmpeg["libx264"] %}
-c:v libx264 \
		{{v.profile|sh_opt("-profile:v")}} {{v.level|sh_opt("-level")}} \
		{{v.framerate|sh_opt("-framerate")}} {{v.maxrate|sh_opt("-maxrate")}} \
		{{v.tune|sh_opt("-tune")}} {{v.x264params|sh_opt("-x264-params")}} \
		{{v.bufsize|sh_opt("-bufsize")}} {{v.crf|sh_opt("-crf")}}
{%- endset -%}

{# create audio encoding options #}
{% set ffmpegac %}
{% set a = ffmpeg["aac"] %}
-c:a aac \
		{{a.channels|sh_opt("-ac")}} {{a.bitrate|sh_opt("-ab")}}
{%- endset -%}

# run command
{{ffmpeg.bin|sh_realpath}} \
	-re -i "$input" \
	-vf scale="$scale720p"$vf_subs \
	{{ffmpegvc}} \
	{{ffmpegac}} \
	-strict experimental -f flv \
"$rtmp_url"/"$rtmp_key"

{# vim: set ft=sh: #}
